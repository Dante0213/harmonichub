
name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Print environment info
        run: |
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
          echo "Current directory: $(pwd)"
          ls -la
      
      - name: Build
        run: npm run build
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: List build output
        run: |
          echo "Build directory contents:"
          ls -la dist/
          echo "All files in build directory:"
          find dist -type f | sort
      
      - name: Create 404.html file
        run: |
          # 단순한 404.html 파일 생성
          cat > dist/404.html << 'EOL'
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>리다이렉트 중...</title>
  <script>
    var pathSegmentsToKeep = 1;
    var l = window.location;
    l.replace(
      l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
      l.pathname.split('/').slice(0, 1 + pathSegmentsToKeep).join('/') + '/?/' +
      l.pathname.slice(1).split('/').slice(pathSegmentsToKeep).join('/').replace(/&/g, '~and~') +
      (l.search ? '&' + l.search.slice(1).replace(/&/g, '~and~') : '') +
      l.hash
    );
  </script>
</head>
<body>
  <h1>페이지를 찾을 수 없습니다</h1>
  <p>곧 홈페이지로 이동합니다. 자동으로 이동하지 않으면 <a href="/music-learn-connect/">여기를 클릭하세요</a>.</p>
</body>
</html>
EOL
          echo "Created 404.html"
          
          # GitHub Pages SPA 라우팅을 위한 리다이렉트 스크립트 추가
          sed -i '/<\/head>/i \
          <script>\
            (function() {\
              var redirect = sessionStorage.redirect;\
              delete sessionStorage.redirect;\
              if (redirect && redirect != location.href) {\
                history.replaceState(null, null, redirect);\
              }\
            })();\
          </script>' dist/index.html
          echo "Updated index.html with redirect script"
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
